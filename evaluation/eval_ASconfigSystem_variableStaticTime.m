%
% SCRIPT TO COMPARE RESULTS & GROUND-TRUTH FOR ABANDONED & STOLEN OBJECT DETECTION USING VIPER
%
%  We use the tool viper-pe to perform the groundtrut-results comparisons
%  Available at http://viper-toolkit.sourceforge.net/ 
%  	  
%  For each results file (*.xml) in the 'results_path', we obtain several files
%  in the same directory as the xml file:
%	- RAW results *.raw [results of evaluation]
%	- OUT results *.out [results of evaluation (human readable)]
%	- LOG results *.logpe [command output generated by viper-pe] 
%
% Author: Juan Carlos San Miguel (juancarlos.sanmiguel@uam.es)
% Created on 18/12/2017
clc; clear all ; close all;
addpath(genpath('./funs/'));

%% CONFIGURATION
%paths
bin_path     = './bin/viper/';      %path where binaries are located (YOU CAN CHANGE)
results_path = './results_stage1/';		%path where results are located (YOU CAN CHANGE)
dataset_path = './datasets_evaluation/';		%path where datasets are located (YOU CAN CHANGE)
temp_path    = './temp/';     		%path where temp files are generated (YOU CAN CHANGE)

%executable commands
viper   = 'viper-pe.jar';			%performance evaluation tool   (YOU CAN CHANGE)
epf     = 'config.epf';             %configuration to match events (YOU CAN CHANGE)
props   = 'properties.pr';          %selected properties of events (YOU CAN CHANGE)
exe_cmd=sprintf('java -jar %s%s -epf %s%s -pr %s%s',bin_path,viper,bin_path,epf,bin_path,props);

%parameters
gt.time2static = 10;                   %default time for ground-truth (in seconds)
gt.evtName = 'AbandonedObject';        %tag/name of the event to modify

%creation of temporal directories
mkdir(temp_path);                      %create root tmp directory

%% process results
resDirs = dirdir(results_path); %get the directories of results

for r=1:numel(resDirs)
        
    resDir = resDirs(r).name;         %get directory of the results    
    resPar = getParameters(resDir);   %get parameters of the results (fps, numframes,time2static,...)
    mkdir([temp_path resDir]);        %create tmp directory
        
    %get all files with the results
    files = getfilenames([results_path resDir],'*.xml');
    fprintf('Processing dir %s (%d files)...\n', resDir, numel(files));    
        
    for f=1:numel(files)
        refile = char(files(f));                  %get the file to process        
        fprintf('\tProcessing %s...\n', refile);   
        
        %create the ground-truth filename
        [path,name,ext]=fileparts(refile);        
        gtname=[name(1:end-25) '.gt'];
        
        %find the ground-truth file in dataset directory
        gtfile=getfilenames(dataset_path,gtname);
        
        %generate XML ground-truth from baseline
        gtfilenew = processGTxml(gtfile,[temp_path resDir '/'],resPar,gt);
        
        %create&run executable command to perform evaluation
        command=sprintf('%s -g %s -r %s -raw %s -o %s > %s 2>&1',exe_cmd,...
            gtfilenew,refile,...
            fullfile(path,[name '.raw']),...
            fullfile(path,[name '.out']),...
            fullfile(path,[name '.logpe']));        
        system(command); %run the command to compare grount-truth & results        
    end
end
